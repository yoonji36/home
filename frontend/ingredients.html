<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>식재료 리스트</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    @font-face {
        font-family: 'LOTTERIACHAB';
        src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2302@1.0/LOTTERIACHAB.woff2') format('woff2');
        font-weight: normal;
        font-style: normal;
    }

    .navbar {
        background-color: rgb(60, 173, 143); /* 메뉴바 색상 */
        font-family: 'LOTTERIACHAB'; /* 메뉴바에 폰트 적용 */
        font-size: 1.5rem;
        font-weight: 100;
        padding: 10px 20px;
        height: 10vh;
    }

    body {
        background-color: rgb(254, 252, 218);
        font-family: 'Arial', sans-serif;
        margin: 0;
        padding: 0;
    }

    header {
        background-color: rgb(60, 173, 143);
        display: flex;
        justify-content: space-between;
        padding: 10px 20px;
        color: black;
        align-items: center;
        height: 10vh;
    }

    .logo a {
        font-family: 'LOTTERIACHAB', sans-serif;
        font-size: 2.5rem;
        color: black;
        text-decoration: none;
    }

    .container {
        display: flex;
        width: 100%;
        height: 90vh;
        gap: 20px;
        padding: 20px;
        font-size: 1.5em;
    }

    .ingredient-section {
        width: 50%; /* 좌측 영역 */
    }

    .ingredient-title {
        margin-bottom: 10px;
        font-size: 3rem;
        font-weight: bold;
    }

    .ingredient-list {
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .ingredient-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .btn-delete-inline {
        display: none;
        background-color: #f44336;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
    }

    .btn-delete-inline:hover {
        background-color: #d32f2f;
    }

    .controls {
        width: 50%; /* 우측 영역 */
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        justify-content: center; /* 세로 중앙 정렬 */
        align-items: center; /* 가로 중앙 정렬 */
        height: 100%; /* 부모 컨테이너의 전체 높이 */
    }

    .add-section {
        width: 100%; /* 섹션이 전체 너비를 차지 */
        margin-bottom: 50px;
    }

    .add-controls {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }

    .add-controls input {
        flex: 1;
        border-radius: 8px;
        border: 1px solid #ddd;
        padding: 10px;
    }

    .btn-custom {
        background-color: rgb(60, 173, 143);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
    }

    .btn-custom:hover {
        background-color: black;
    }

    .calorie-section {
        margin-top: 20px;
        width: 100%; /* 섹션이 전체 너비를 차지 */
    }

    .calorie-section input {
        width: 100px;
        border-radius: 8px;
        text-align: center;
        margin-bottom: 50px;
        margin-top: 20px;
    }

    .makerecipe-section .recipe-btn {
        background-color: rgb(60, 173, 143);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        width: 100%;
    }

    .makerecipe-section .recipe-btn:hover {
        background-color: black;
    }
    </style>
</head>
<body>

<navbar class="navbar" style="padding: 15px;">
    <div class="container-fluid">
        <a class="navbar-brand text-white" href="#">
            <span style="font-size: 1.75em;">혈당히어로</span>
        </a>
        <ul class="nav">
            <li class="nav-item">
                <a class="nav-link {% if request.path == '/' %}text-white{% else %}text-dark{% endif %}" href="/">레시피 생성</a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if request.path == '/records/' %}text-dark{% else %}text-white{% endif %}" href="/records/">내 기록</a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if request.path == '/info/' %}text-dark{% else %}text-white{% endif %}" href="/info/">내 정보</a>
            </li>
            <li class="nav-item">
                <a class="nav-link text-white" href="#"><img src="logout.png" alt="로그아웃 아이콘" style="width: 30px;"></a>
            </li>
        </ul>
    </div>
</navbar>

<div class="container">
    <!-- 좌측 식재료 리스트 섹션 -->
    <div class="ingredient-section">
        <div class="ingredient-title">식재료 리스트</div>
        <div class="ingredient-list" id="ingredient-list">
            {% for ingredient in ingredients %}
            <div class="ingredient-item">
                <input type="checkbox" onclick="toggleDeleteButton(this)">
                <span>{{ ingredient }}</span>
                <button class="btn-delete-inline" onclick="deleteIngredient(this)">삭제</button>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- 우측 재료 추가 및 레시피 생성 섹션 -->
    <div class="controls">
        <div class="add-section">
            <p><li>원하는 재료를 추가하세요</li></p>
            <div class="add-controls">
                <input type="text" id="new-ingredient" placeholder="재료를 입력하세요">
                <button class="btn-custom" id="add-ingredient-btn">재료 추가</button>
            </div>
        </div>

        <div class="calorie-section">
            <span style="text-align: left;"><li>생성할 레시피의 최대 칼로리를 입력하세요</li></span>
            <input type="number" value="500" id="calorie-input">
        </div>

        <div class="makerecipe-section">
            <button class="recipe-btn" id="recipe-btn">레시피 생성하기</button>
        </div>

    </div>

</div>

<script>
    // 재료 추가 기능
    document.getElementById('add-ingredient-btn').addEventListener('click', function () {
        const newIngredient = document.getElementById('new-ingredient').value.trim();
        if (newIngredient) {
            const ingredientList = document.getElementById('ingredient-list');
            const newItem = document.createElement('div');
            newItem.classList.add('ingredient-item');
            newItem.innerHTML = `
                <input type="checkbox" onclick="toggleDeleteButton(this)">
                <span>${newIngredient}</span>
                <button class="btn-delete-inline" onclick="deleteIngredient(this)">삭제</button>
            `;
            ingredientList.appendChild(newItem);
            document.getElementById('new-ingredient').value = ''; // 입력 필드 초기화
        }
    });

    // 체크박스 클릭 시 삭제 버튼 표시/숨김 기능
    function toggleDeleteButton(checkbox) {
        const deleteButton = checkbox.parentElement.querySelector('.btn-delete-inline');
        deleteButton.style.display = checkbox.checked ? 'inline-block' : 'none';
    }

    // 재료 삭제 기능
    function deleteIngredient(button) {
        button.parentElement.remove();
    }

    // 버튼 클릭 시, 레시피 생성 이벤트 핸들러 
    document.getElementById('recipe-btn').addEventListener('click', async function () {
        const calorieLimit = document.getElementById('calorie-input').value;
        const ingredients = Array.from(document.querySelectorAll('.ingredient-item span'))
            .map(span => span.textContent);

        if (ingredients.length === 0) {
            alert('최소 하나 이상의 재료를 추가해주세요.');
            return;
        }

        try {
            console.log('재료:', ingredients);
            console.log('칼로리 제한:', calorieLimit);

            // GPT API 호출
            const response = await fetch('/mdl/api/recipe/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    calorie: calorieLimit,
                    ingredients: ingredients,
                }),
            });

            if (!response.ok) throw new Error('레시피 생성 실패');

            const data = await response.json();
            console.log('API 응답 데이터:', data);

            // 응답 데이터를 쿼리스트링으로 인코딩
            const recipeData = encodeURIComponent(JSON.stringify(data.recipe));
            
            // recipes.html로 이동하며 레시피 데이터 전달
            window.location.href = `/mdl/recipes/?recipe=${recipeData}`;
        } catch (error) {
            console.error('레시피 생성 중 오류:', error);
            alert('레시피 생성 중 문제가 발생했습니다. 다시 시도해주세요.');
        }
    });

</script>

</body>
</html>
